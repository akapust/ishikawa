<!-- =========================
     MINMAP TOOL (DE/EN)
     jsMind + Zoom/Pan + Undo/Redo + Reset
     Maßnahmen: Draft -> Speichern -> Maßnahmenliste (Status, Termin, Owner)
     JSON Import/Export + Print
     Intro Grid: Ziel, Schritte, Datenschutz
     Links: Lexikon Mindmap + Seminare (KVP, QM, OPEX, FMEA)
========================= -->

<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mindmap Tool – Ideen → Bewertung → Maßnahmen</title>

  <!-- jsMind (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsmind@0.8.5/style/jsmind.css">
  <script src="https://cdn.jsdelivr.net/npm/jsmind@0.8.5/es6/jsmind.js"></script>

  <style>
    :root{
      --blue:#1155b2;
      --dark:#09387a;
      --light-bg:#f8fafc;
      --border:#d1d9e6;
      --text:#27304d;
      --muted:#64748b;

      --note:#fff9c4;

      --green:#16a34a;
      --yellow:#f59e0b;
      --red:#e53e3e;

      --radius:4px;
      --shadow:0 4px 12px rgba(0,0,0,0.10);
    }

    body{ margin:0; background:#fff; color:var(--text); font-family:'Segoe UI', Roboto, sans-serif; }

    .app{ max-width:1100px; margin:20px auto; padding:0 12px; }
    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    /* Intro (wie eure Tools) */
    .tool-intro{ padding:22px 25px; border-bottom:3px solid var(--blue); background:var(--light-bg); }
    .tool-intro-top{ display:flex; align-items:flex-start; justify-content:space-between; gap:15px; flex-wrap:wrap; }
    .tool-title{ margin:0; color:var(--dark); font-size:20px; text-transform:uppercase; }
    .tool-sub{ margin:6px 0 0; font-size:13px; color:var(--muted); }

    .tool-grid{ margin-top:16px; display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .tool-box{ background:#fff; border:1px solid var(--border); border-radius:var(--radius); padding:12px 14px; }
    .tool-box h3{ margin:0 0 6px; font-size:13px; color:var(--dark); text-transform:uppercase; }
    .tool-box p, .tool-box ol{ margin:0; font-size:13px; color:#334155; }
    .tool-box ol{ padding-left:18px; }
    .tool-privacy{ border-left:3px solid var(--blue); }

    .tool-box a{ color:var(--blue); text-decoration:none; }
    .tool-box a:hover{ text-decoration:underline; }

    /* Buttons */
    .btn{
      padding:10px 18px;
      font-size:13px;
      font-weight:800;
      border-radius:var(--radius);
      cursor:pointer;
      border:1px solid var(--border);
      background:#fff;
      text-transform:uppercase;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      color:#334155;
      user-select:none;
    }
    .btn.primary{ background:var(--blue); border-color:var(--blue); color:#fff; }
    .btn.primary:hover{ background:var(--dark); border-color:var(--dark); }
    .btn.danger{ color:var(--red); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .lang-switch{ display:flex; gap:8px; align-items:center; }
    .lang-switch .btn{ padding:8px 12px; font-size:12px; }

    .body{ padding:25px; }

    /* Meta */
    .meta-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-bottom:14px;
    }
    .meta-full{ grid-column:1 / -1; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .label{ font-size:12px; color:var(--muted); font-weight:900; text-transform:uppercase; }
    .input, .textarea{
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:10px;
      font-size:13px;
      font-family:inherit;
      outline:none;
      background:#fff;
    }
    .textarea{ min-height:70px; resize:vertical; }

    .savebar{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      padding:10px 12px;
      border:1px solid #edf2f7;
      background:#fff;
      border-radius:var(--radius);
      margin-bottom:16px;
    }
    .savebadge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(17,85,178,.25);
      background:#fff;
      font-size:12px;
      font-weight:900;
      color:var(--dark);
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:var(--green); display:inline-block; }
    .dot.saving{ background:var(--yellow); }
    .dot.idle{ background:#94a3b8; }

    /* Map area */
    .map-wrap{
      border:1px solid #edf2f7;
      border-radius:var(--radius);
      background:#fff;
      overflow:hidden;
    }
    .map-head{
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px; flex-wrap:wrap;
      padding:12px;
      background:var(--light-bg);
      border-bottom:1px solid #eef2f7;
    }
    .map-title{ margin:0; font-size:13px; font-weight:900; color:var(--dark); text-transform:uppercase; }
    .map-sub{ margin:4px 0 0; font-size:12px; color:var(--muted); }
    .map-actions{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; justify-content:flex-end; }

    .btn.small{ padding:8px 10px; font-size:11px; }
    .btn.ghost{ background:#fff; }

    .jm-container{
      position:relative;
      height:480px;
      background:radial-gradient(circle at center, rgba(17,85,178,.06) 0%, transparent 65%);
    }

    /* Overlay for pan/zoom instructions */
    .hint{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
    }

    /* Selected node info */
    .selbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin:12px 0 16px;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid rgba(17,85,178,.25);
      border-radius:999px;
      padding:6px 10px;
      background:#fff;
      font-size:12px;
      font-weight:900;
      color:#0f172a;
    }
    .chip code{ font-weight:800; color:#475569; }

    /* Bewertung (R/Y/G) */
    .rating-row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top:6px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(100,116,139,.22);
      background:#fff;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:12px;
    }
    .pill .p-dot{ width:10px; height:10px; border-radius:50%; background:#cbd5e1; }
    .pill.red .p-dot{ background:var(--red); }
    .pill.yellow .p-dot{ background:var(--yellow); }
    .pill.green .p-dot{ background:var(--green); }
    .pill.selected{
      box-shadow:0 6px 14px rgba(0,0,0,.08);
      transform:translateY(-1px);
      border-color:rgba(15,23,42,.28);
    }

    /* Maßnahmen */
    .divider{ height:1px; background:#edf2f7; margin:16px 0; }

    .section-title{ margin:0 0 6px; font-size:13px; color:var(--dark); text-transform:uppercase; font-weight:900; }
    .section-sub{ margin:0 0 10px; font-size:13px; color:var(--muted); }

    .draft{
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px 14px;
      background:#fff;
    }
    .draft-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    .draft-grid .meta-full{ grid-column:1 / -1; }

    .mini-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }

    .actions-table{
      width:100%;
      border-collapse:collapse;
      border:1px solid #e2e8f0;
      border-radius:var(--radius);
      overflow:hidden;
      background:#fff;
    }
    .actions-table th, .actions-table td{
      border-bottom:1px solid #eef2f7;
      padding:10px;
      font-size:13px;
      vertical-align:top;
    }
    .actions-table th{
      background:var(--light-bg);
      text-transform:uppercase;
      font-size:12px;
      color:var(--dark);
      font-weight:900;
    }
    .status{
      display:inline-flex;
      align-items:center;
      gap:8px;
      border-radius:999px;
      padding:5px 9px;
      border:1px solid rgba(100,116,139,.22);
      font-weight:900;
      font-size:12px;
      background:#fff;
      white-space:nowrap;
    }
    .status.open{ border-color:rgba(245,158,11,.35); }
    .status.done{ border-color:rgba(22,163,74,.35); }
    .status.drop{ border-color:rgba(229,62,62,.35); }

    .row-actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .icon-btn{
      padding:7px 10px;
      border:1px solid var(--border);
      border-radius:var(--radius);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      text-transform:uppercase;
    }
    .icon-btn:hover{ border-color:var(--blue); color:var(--blue); background:#f8fafc; }
    .icon-btn.danger{ color:var(--red); }

    /* Export area bottom */
    .exports{
      margin-top:18px;
      padding-top:16px;
      border-top:2px solid var(--blue);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    /* More info */
    .tool-more{ margin-top:22px; padding-top:18px; border-top:2px solid var(--blue); }
    .more-title{ margin:0 0 6px; font-size:13px; color:var(--dark); text-transform:uppercase; }
    .more-sub{ margin:0 0 10px; font-size:13px; color:var(--muted); }
    .more-list{ margin:8px 0 0; padding-left:18px; font-size:13px; color:#334155; }
    .more-list li{ margin:4px 0; }

    /* Footer */
    .footer{
      padding:12px 25px;
      background:var(--light-bg);
      border-top:1px solid var(--border);
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .footer a{ color:var(--dark); font-weight:800; text-decoration:none; }
    .footer a:hover{ text-decoration:underline; }

    /* Toast */
    .toast{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      background:#0f172a;
      color:#fff;
      padding:12px 18px;
      border-radius:999px;
      font-size:14px;
      z-index:9999;
      opacity:0;
      pointer-events:none;
      transition:opacity .25s;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
    }
    .toast.show{ opacity:1; }

    /* Print */
    @media print{
      .lang-switch, .btn, .map-actions, .exports, .tool-more a{ display:none !important; }
      .card{ box-shadow:none !important; border:none !important; }
      .app{ margin:0 !important; }
      .body{ padding:0 !important; }
      .jm-container{ height:520px; }
    }

    @media(max-width:900px){
      .tool-grid{ grid-template-columns:1fr; }
      .meta-grid{ grid-template-columns:1fr; }
      .draft-grid{ grid-template-columns:1fr; }
      .tool-intro, .body, .footer{ padding-left:16px; padding-right:16px; }
    }
  </style>
</head>

<body>
  <div id="mm-app" class="app">
    <section class="card">

      <!-- Intro -->
      <section class="tool-intro">
        <div class="tool-intro-top">
          <div>
            <h2 class="tool-title" data-i18n="title">Mindmap Tool – Ideen → Bewertung → Maßnahmen</h2>
            <p class="tool-sub" data-i18n="subtitle">Mindmap erstellen, bewerten (Rot/Gelb/Grün) und daraus Maßnahmen ableiten.</p>
          </div>

          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
            <div class="lang-switch" aria-label="Language switch">
              <button type="button" class="btn" id="btnLangDE">DE</button>
              <button type="button" class="btn" id="btnLangEN">EN</button>
            </div>
            <a class="btn" href="https://tools.quality.de/" data-i18n="backHome">Zurück zur Startseite</a>
          </div>
        </div>

        <div class="tool-grid">
          <div class="tool-box">
            <h3 data-i18n="boxToolNameTitle">Name Tool</h3>
            <p data-i18n="boxToolNameText">Mindmap – Ideenstruktur & Maßnahmenableitung</p>
          </div>

          <div class="tool-box">
            <h3 data-i18n="boxGoalTitle">Ziel</h3>
            <p data-i18n="boxGoalText">Ideen sammeln, clustern, bewerten und die relevanten Punkte in konkrete Maßnahmen mit Termin/Owner überführen.</p>
          </div>

          <div class="tool-box">
            <h3 data-i18n="boxHowTitle">So benutzt du das Tool</h3>
            <ol>
              <li data-i18n="step1">Thema/Ziel/Scope ausfüllen (Autosave).</li>
              <li data-i18n="step2">Mindmap aufbauen: Unterknoten/Nachbarknoten hinzufügen, verschieben, löschen.</li>
              <li data-i18n="step3">Knoten bewerten: Rot/Gelb/Grün.</li>
              <li data-i18n="step4">Aus Rot/Gelb Maßnahmen ableiten → in Maßnahmenliste speichern.</li>
              <li data-i18n="step5">Ganz unten: JSON speichern/laden & Drucken.</li>
            </ol>
          </div>

          <div class="tool-box tool-privacy">
            <h3 data-i18n="boxPrivacyTitle">Datenschutz</h3>
            <p data-i18n="boxPrivacyText">Dieses Tool arbeitet vollständig im Browser. Es werden keine Daten auf einem Server gespeichert. Zugriff hat nur die Person, die lokal speichert oder lädt.</p>
          </div>
        </div>
      </section>

      <div class="body">
        <!-- Meta -->
        <div class="meta-grid">
          <div class="field">
            <label class="label" for="scopeTopic" data-i18n="lblTopic">Thema / Titel</label>
            <input class="input" id="scopeTopic" type="text" placeholder="z.B. Prozess X verbessern / Brainstorming Workshop" data-i18n-placeholder="phTopic" />
          </div>
          <div class="field">
            <label class="label" for="scopeGoal" data-i18n="lblGoal">Ziel</label>
            <input class="input" id="scopeGoal" type="text" placeholder="z.B. 10 umsetzbare Verbesserungen bis Ende Q2" data-i18n-placeholder="phGoal" />
          </div>
          <div class="field meta-full">
            <label class="label" for="scopeScope" data-i18n="lblScope">Scope / Abgrenzung</label>
            <input class="input" id="scopeScope" type="text" placeholder="z.B. Linie A / Standort Berlin / nur Inbound" data-i18n-placeholder="phScope" />
          </div>
          <div class="field meta-full">
            <label class="label" for="scopeNotes" data-i18n="lblNotes">Notizen</label>
            <textarea class="textarea" id="scopeNotes" placeholder="Rahmen, Teilnehmer, Annahmen, Links..." data-i18n-placeholder="phNotes"></textarea>
          </div>
        </div>

        <div class="savebar" aria-live="polite">
          <span class="savebadge"><span id="saveDot" class="dot saving"></span><span id="saveText" data-i18n="saving">Speichern…</span></span>
          <span style="font-size:12px;color:var(--muted);" id="saveWhen"></span>
        </div>

        <!-- Mindmap -->
        <div class="map-wrap">
          <div class="map-head">
            <div>
              <p class="map-title" data-i18n="mapTitle">Mindmap</p>
              <p class="map-sub" data-i18n="mapSub">Scroll = Zoom · Drag = Pan · Recenter = Zentrieren · Unterknoten/Nachbarknoten hinzufügen</p>
            </div>
            <div class="map-actions">
              <button type="button" class="btn small" id="btnRecenter" data-i18n="btnRecenter">Zentrieren</button>
              <button type="button" class="btn small" id="btnUndo" data-i18n="btnUndo">Rückgängig</button>
              <button type="button" class="btn small" id="btnRedo" data-i18n="btnRedo">Wiederholen</button>
              <button type="button" class="btn small" id="btnDelete" data-i18n="btnDelete">Löschen</button>
              <button type="button" class="btn small danger" id="btnResetMap" data-i18n="btnResetMap">Reset</button>
            </div>
          </div>

          <div class="jm-container" id="jmWrap">
            <div id="jsmind_container" style="width:100%;height:100%;"></div>
          </div>
        </div>

        <div class="selbar">
          <span class="chip" id="selChip"><span data-i18n="selected">Ausgewählt</span>: <code id="selNode">root</code></span>
          <span class="chip" id="pathChip"><span data-i18n="path">Pfad</span>: <code id="selPath">—</code></span>
        </div>

        <div class="draft">
          <h3 class="section-title" data-i18n="rateTitle">2) Bewerten</h3>
          <p class="section-sub" data-i18n="rateSub">Bewerte den ausgewählten Knoten. Rot/Gelb können in Maßnahmen überführt werden (Bewertung ist jederzeit änderbar).</p>

          <div class="rating-row" id="ratingRow" aria-label="Bewertung">
            <div class="pill red" data-rate="red"><span class="p-dot"></span><span data-i18n="rateRed">Rot</span></div>
            <div class="pill yellow" data-rate="yellow"><span class="p-dot"></span><span data-i18n="rateYellow">Gelb</span></div>
            <div class="pill green" data-rate="green"><span class="p-dot"></span><span data-i18n="rateGreen">Grün</span></div>
            <span style="color:var(--muted);font-size:12px;" id="rateInfo"></span>
          </div>

          <div class="divider"></div>

          <h3 class="section-title" data-i18n="actionsDraftTitle">3) Ableitung von Maßnahmen</h3>
          <p class="section-sub" data-i18n="actionsDraftSub">Erstelle aus dem ausgewählten (Rot/Gelb) Knoten eine Maßnahme. Speichern legt sie in der Maßnahmenliste ab und leert das Formular.</p>

          <div class="draft-grid">
            <div class="field meta-full">
              <label class="label" data-i18n="lblFromNode">Bezug (Knoten)</label>
              <input class="input" id="actFrom" type="text" readonly />
            </div>

            <div class="field meta-full">
              <label class="label" for="actText" data-i18n="lblAction">Maßnahme</label>
              <textarea class="textarea" id="actText" placeholder="Was wird getan? (klar, überprüfbar)" data-i18n-placeholder="phAction"></textarea>
            </div>

            <div class="field">
              <label class="label" for="actOwner" data-i18n="lblOwner">Owner</label>
              <input class="input" id="actOwner" type="text" placeholder="z.B. Max Mustermann" data-i18n-placeholder="phOwner" />
            </div>
            <div class="field">
              <label class="label" for="actDue" data-i18n="lblDue">Termin</label>
              <input class="input" id="actDue" type="date" />
            </div>

            <div class="field">
              <label class="label" for="actStatus" data-i18n="lblStatus">Status</label>
              <select class="input" id="actStatus">
                <option value="open" data-i18n="stOpen">Offen</option>
                <option value="done" data-i18n="stDone">Abgeschlossen</option>
                <option value="drop" data-i18n="stDrop">Verworfen</option>
              </select>
            </div>

            <div class="field">
              <label class="label" for="actNote" data-i18n="lblActionNote">Notiz (optional)</label>
              <input class="input" id="actNote" type="text" placeholder="z.B. Nachweis / Link / Messkriterium" data-i18n-placeholder="phActionNote" />
            </div>
          </div>

          <div class="mini-actions">
            <button type="button" class="btn primary" id="btnSaveAction" data-i18n="btnSaveAction">In Maßnahmenliste speichern</button>
            <button type="button" class="btn" id="btnClearDraft" data-i18n="btnClearDraft">Entwurf leeren</button>
          </div>

          <div class="hint" id="draftHint"></div>
        </div>

        <div class="divider"></div>

        <h3 class="section-title" data-i18n="actionsListTitle">Maßnahmenliste</h3>
        <p class="section-sub" data-i18n="actionsListSub">Hier sind alle gespeicherten Maßnahmen. Status ändern, bearbeiten oder löschen.</p>

        <div style="overflow:auto;">
          <table class="actions-table" aria-label="Maßnahmenliste">
            <thead>
              <tr>
                <th data-i18n="thAction">Maßnahme</th>
                <th data-i18n="thFrom">Bezug</th>
                <th data-i18n="thOwner">Owner</th>
                <th data-i18n="thDue">Termin</th>
                <th data-i18n="thStatus">Status</th>
                <th data-i18n="thOps">Aktion</th>
              </tr>
            </thead>
            <tbody id="actionsBody"></tbody>
          </table>
        </div>

        <!-- Export/Print (muss vor "Weitere Infos" sein) -->
        <div class="exports">
          <button type="button" class="btn primary" id="btnPrint" data-i18n="btnPrint">Drucken</button>
          <button type="button" class="btn" id="btnExportJson" data-i18n="btnExportJson">JSON speichern</button>
          <button type="button" class="btn" id="btnImportJson" data-i18n="btnImportJson">JSON laden</button>
          <input type="file" id="jsonFile" accept="application/json" style="display:none;" />
          <span style="flex:1 1 auto;"></span>
          <a class="btn" href="https://tools.quality.de/" data-i18n="backHome">Zurück zur Startseite</a>
        </div>

        <!-- More info -->
        <section class="tool-more">
          <h3 class="more-title" data-i18n="moreTitle">Weiterführende Infos</h3>
          <p class="more-sub" data-i18n="moreSub">Lexikonartikel & passende Weiterbildungen (öffnet in neuem Tab).</p>

          <div class="tool-grid">
            <div class="tool-box">
              <h3 data-i18n="lexTitle">Lexikon</h3>
              <p data-i18n="lexText">Definition, Einsatzbereiche & Tipps zum Mindmapping.</p>
              <p style="margin-top:8px;">
                <a href="https://www.quality.de/lexikon/mindmap/" target="_blank" rel="noopener" data-i18n="lexLink">Zum Lexikonartikel: Mindmap</a>
              </p>
            </div>

            <div class="tool-box">
              <h3 data-i18n="trainTitle">Ausbildungen &amp; Seminare</h3>
              <p data-i18n="trainText">Vertiefe deine Methodenkompetenz im Qualitätsmanagement:</p>
              <ul class="more-list">
                <li><a href="https://www.quality.de/weiterbildung/kvp/" target="_blank" rel="noopener" data-i18n="trainKvp">KVP Seminare</a></li>
                <li><a href="https://www.quality.de/weiterbildung/qualitaetsmanagement/" target="_blank" rel="noopener" data-i18n="trainQm">Qualitätsmanagement</a></li>
                <li><a href="https://www.quality.de/weiterbildung/opex-seminare-ausbildungen/" target="_blank" rel="noopener" data-i18n="trainOpex">OPEX Seminare &amp; Ausbildungen</a></li>
                <li><a href="https://www.quality.de/weiterbildung/fmea-schulung/" target="_blank" rel="noopener" data-i18n="trainFmea">FMEA Schulungen</a></li>
              </ul>
            </div>
          </div>
        </section>

      </div>

      <footer class="footer">
        <div>© <span id="copyrightYear"></span></div>
        <div><a href="https://www.quality.de/" target="_blank" rel="noopener"><span data-i18n="poweredBy">Quality Services &amp; Wissen GmbH</span></a></div>
      </footer>

    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

  <script>
  (function(){
    /* ================= i18n ================= */
    const I18N = {
      de:{
        title:"Mindmap Tool – Ideen → Bewertung → Maßnahmen",
        subtitle:"Mindmap erstellen, bewerten (Rot/Gelb/Grün) und daraus Maßnahmen ableiten.",
        backHome:"Zurück zur Startseite",

        boxToolNameTitle:"Name Tool",
        boxToolNameText:"Mindmap – Ideenstruktur & Maßnahmenableitung",
        boxGoalTitle:"Ziel",
        boxGoalText:"Ideen sammeln, clustern, bewerten und die relevanten Punkte in konkrete Maßnahmen mit Termin/Owner überführen.",
        boxHowTitle:"So benutzt du das Tool",
        step1:"Thema/Ziel/Scope ausfüllen (Autosave).",
        step2:"Mindmap aufbauen: Unterknoten/Nachbarknoten hinzufügen, verschieben, löschen.",
        step3:"Knoten bewerten: Rot/Gelb/Grün.",
        step4:"Aus Rot/Gelb Maßnahmen ableiten → in Maßnahmenliste speichern.",
        step5:"Ganz unten: JSON speichern/laden & Drucken.",
        boxPrivacyTitle:"Datenschutz",
        boxPrivacyText:"Dieses Tool arbeitet vollständig im Browser. Es werden keine Daten auf einem Server gespeichert. Zugriff hat nur die Person, die lokal speichert oder lädt.",

        lblTopic:"Thema / Titel",
        lblGoal:"Ziel",
        lblScope:"Scope / Abgrenzung",
        lblNotes:"Notizen",
        phTopic:"z.B. Prozess X verbessern / Brainstorming Workshop",
        phGoal:"z.B. 10 umsetzbare Verbesserungen bis Ende Q2",
        phScope:"z.B. Linie A / Standort Berlin / nur Inbound",
        phNotes:"Rahmen, Teilnehmer, Annahmen, Links...",

        saving:"Speichern…",
        saved:"Gespeichert",
        lastSaved:"Zuletzt gespeichert:",

        mapTitle:"Mindmap",
        mapSub:"Scroll = Zoom · Drag = Pan · Recenter = Zentrieren · Unterknoten/Nachbarknoten hinzufügen",
        btnRecenter:"Zentrieren",
        btnUndo:"Rückgängig",
        btnRedo:"Wiederholen",
        btnDelete:"Löschen",
        btnResetMap:"Reset",

        selected:"Ausgewählt",
        path:"Pfad",

        rateTitle:"2) Bewerten",
        rateSub:"Bewerte den ausgewählten Knoten. Rot/Gelb können in Maßnahmen überführt werden (Bewertung ist jederzeit änderbar).",
        rateRed:"Rot",
        rateYellow:"Gelb",
        rateGreen:"Grün",
        rateNone:"Keine Bewertung",
        rateInfo:"Bewertung:",

        actionsDraftTitle:"3) Ableitung von Maßnahmen",
        actionsDraftSub:"Erstelle aus dem ausgewählten (Rot/Gelb) Knoten eine Maßnahme. Speichern legt sie in der Maßnahmenliste ab und leert das Formular.",
        lblFromNode:"Bezug (Knoten)",
        lblAction:"Maßnahme",
        phAction:"Was wird getan? (klar, überprüfbar)",
        lblOwner:"Owner",
        phOwner:"z.B. Max Mustermann",
        lblDue:"Termin",
        lblStatus:"Status",
        stOpen:"Offen",
        stDone:"Abgeschlossen",
        stDrop:"Verworfen",
        lblActionNote:"Notiz (optional)",
        phActionNote:"z.B. Nachweis / Link / Messkriterium",

        btnSaveAction:"In Maßnahmenliste speichern",
        btnClearDraft:"Entwurf leeren",

        actionsListTitle:"Maßnahmenliste",
        actionsListSub:"Hier sind alle gespeicherten Maßnahmen. Status ändern, bearbeiten oder löschen.",
        thAction:"Maßnahme",
        thFrom:"Bezug",
        thOwner:"Owner",
        thDue:"Termin",
        thStatus:"Status",
        thOps:"Aktion",
        btnEdit:"Bearbeiten",
        btnUpdate:"Speichern",
        btnCancel:"Abbrechen",
        btnDel:"Löschen",

        btnPrint:"Drucken",
        btnExportJson:"JSON speichern",
        btnImportJson:"JSON laden",

        moreTitle:"Weiterführende Infos",
        moreSub:"Lexikonartikel & passende Weiterbildungen (öffnet in neuem Tab).",
        lexTitle:"Lexikon",
        lexText:"Definition, Einsatzbereiche & Tipps zum Mindmapping.",
        lexLink:"Zum Lexikonartikel: Mindmap",
        trainTitle:"Ausbildungen & Seminare",
        trainText:"Vertiefe deine Methodenkompetenz im Qualitätsmanagement:",
        trainKvp:"KVP Seminare",
        trainQm:"Qualitätsmanagement",
        trainOpex:"OPEX Seminare & Ausbildungen",
        trainFmea:"FMEA Schulungen",

        poweredBy:"Quality Services & Wissen GmbH",

        promptNodeText:"Text für den neuen Knoten:",
        warnSelectNode:"Bitte zuerst einen Knoten auswählen.",
        warnSiblingRoot:"Für den Root-Knoten ist kein Nachbarknoten möglich.",
        warnAddFailed:"Knoten konnte nicht hinzugefügt werden.",
        confirmDelete:"Ausgewählten Knoten löschen?",
        confirmReset:"Mindmap zurücksetzen (inkl. Bewertungen)?",
        confirmImport:"JSON laden? Aktuelle Daten werden überschrieben.",
        loadError:"Fehler beim Laden der Datei.",
        savedAction:"Maßnahme gespeichert.",
        needRedYellow:"Nur Rot oder Gelb werden typischerweise in Maßnahmen überführt (du kannst trotzdem speichern)."
      },
      en:{
        title:"Mindmap Tool – Ideas → Rating → Actions",
        subtitle:"Create a mind map, rate nodes (Red/Yellow/Green) and derive actions.",
        backHome:"Back to home",

        boxToolNameTitle:"Tool name",
        boxToolNameText:"Mind map – idea structure & action derivation",
        boxGoalTitle:"Goal",
        boxGoalText:"Collect ideas, cluster them, rate nodes and turn relevant points into concrete actions incl. due date/owner.",
        boxHowTitle:"How to use this tool",
        step1:"Fill topic/goal/scope (autosave).",
        step2:"Build the mind map: add child/sibling nodes, move, delete.",
        step3:"Rate nodes: red/yellow/green.",
        step4:"Derive actions from red/yellow → save to action list.",
        step5:"At the bottom: save/load JSON & print.",
        boxPrivacyTitle:"Privacy",
        boxPrivacyText:"This tool runs entirely in your browser. No data is stored on any server. Only the person saving/loading locally has access.",

        lblTopic:"Topic / Title",
        lblGoal:"Goal",
        lblScope:"Scope / boundaries",
        lblNotes:"Notes",
        phTopic:"e.g. Improve process X / workshop mind map",
        phGoal:"e.g. 10 implementable improvements by end of Q2",
        phScope:"e.g. Line A / Berlin site / inbound only",
        phNotes:"Context, participants, assumptions, links...",

        saving:"Saving…",
        saved:"Saved",
        lastSaved:"Last saved:",

        mapTitle:"Mind map",
        mapSub:"Scroll = zoom · Drag = pan · Recenter · Add child/sibling nodes",
        btnRecenter:"Recenter",
        btnUndo:"Undo",
        btnRedo:"Redo",
        btnDelete:"Delete",
        btnResetMap:"Reset",

        selected:"Selected",
        path:"Path",

        rateTitle:"2) Rating",
        rateSub:"Rate the selected node. Red/Yellow can be turned into actions (rating can be changed anytime).",
        rateRed:"Red",
        rateYellow:"Yellow",
        rateGreen:"Green",
        rateNone:"No rating",
        rateInfo:"Rating:",

        actionsDraftTitle:"3) Derive actions",
        actionsDraftSub:"Create an action from the selected (red/yellow) node. Saving moves it to the action list and clears the form.",
        lblFromNode:"Reference (node)",
        lblAction:"Action",
        phAction:"What will be done? (clear, verifiable)",
        lblOwner:"Owner",
        phOwner:"e.g. Jane Doe",
        lblDue:"Due date",
        lblStatus:"Status",
        stOpen:"Open",
        stDone:"Done",
        stDrop:"Discarded",
        lblActionNote:"Note (optional)",
        phActionNote:"e.g. evidence / link / acceptance criteria",

        btnSaveAction:"Save to action list",
        btnClearDraft:"Clear draft",

        actionsListTitle:"Action list",
        actionsListSub:"All saved actions appear here. Change status, edit or delete.",
        thAction:"Action",
        thFrom:"Reference",
        thOwner:"Owner",
        thDue:"Due",
        thStatus:"Status",
        thOps:"Ops",
        btnEdit:"Edit",
        btnUpdate:"Save",
        btnCancel:"Cancel",
        btnDel:"Delete",

        btnPrint:"Print",
        btnExportJson:"Save JSON",
        btnImportJson:"Load JSON",

        moreTitle:"More information",
        moreSub:"Glossary & relevant training (opens in a new tab).",
        lexTitle:"Glossary",
        lexText:"Definition, use cases & tips for mind mapping.",
        lexLink:"Open glossary article: Mind map",
        trainTitle:"Training & courses",
        trainText:"Deepen your method skills in quality management:",
        trainKvp:"CIP / Kaizen (KVP) training",
        trainQm:"Quality management",
        trainOpex:"OPEX courses",
        trainFmea:"FMEA training",

        poweredBy:"Quality Services & Wissen GmbH",

        promptNodeText:"Text for the new node:",
        warnSelectNode:"Please select a node first.",
        warnSiblingRoot:"No sibling node for the root node.",
        warnAddFailed:"Node could not be added.",
        confirmDelete:"Delete selected node?",
        confirmReset:"Reset the mind map (incl. ratings)?",
        confirmImport:"Load JSON? Current data will be overwritten.",
        loadError:"Error loading file.",
        savedAction:"Action saved.",
        needRedYellow:"Typically only Red or Yellow are converted to actions (you can still save)."
      }
    };

    let currentLang = (localStorage.getItem("qmLang")
      || (navigator.language && navigator.language.toLowerCase().startsWith("de") ? "de" : "en"));

    function t(key){ return (I18N[currentLang] && I18N[currentLang][key]) ? I18N[currentLang][key] : key; }

    function applyI18n(){
      document.documentElement.lang = currentLang;

      document.querySelectorAll("[data-i18n]").forEach(el=>{
        el.textContent = t(el.dataset.i18n);
      });
      document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
        el.placeholder = t(el.dataset.i18nPlaceholder);
      });

      const deBtn = document.getElementById("btnLangDE");
      const enBtn = document.getElementById("btnLangEN");
      if(deBtn && enBtn){
        deBtn.classList.toggle("primary", currentLang==="de");
        enBtn.classList.toggle("primary", currentLang==="en");
      }
    }

    function setLanguage(lang){
      currentLang = (lang==="de"||lang==="en") ? lang : "de";
      localStorage.setItem("qmLang", currentLang);
      applyI18n();
      renderActionsTable();
      updateRatingUI();
      updateDraftHint();
      updateSaveLabel(true);
    }

    /* ================= State ================= */
    const STORAGE_KEY = "qm_mindmap_state_v1";

    const $ = (id)=> document.getElementById(id);

    function uid(){
      try{ return crypto.randomUUID(); }catch{ return "id_" + Math.random().toString(16).slice(2); }
    }
    function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

    function toast(msg){
      const el = document.getElementById("toast");
      if(!el) return;
      el.textContent = msg;
      el.classList.add("show");
      clearTimeout(toast._tmr);
      toast._tmr = setTimeout(()=> el.classList.remove("show"), 2600);
    }

    let state = {
      lang: currentLang,
      meta:{ topic:"", goal:"", scope:"", notes:"" },
      mind:{
        // jsMind format: node array
        nodes:[
          { id:"root", isroot:true, topic:"Mindmap" }
        ],
        // ratings per node id: 'red' | 'yellow' | 'green' | null
        ratings:{}
      },
      actions:[], // list items: {id, fromId, fromPath, fromText, text, owner, due, status, note, ts}
      ts: new Date().toISOString()
    };

    /* History for undo/redo (map + ratings) */
    const history = { past:[], future:[] };
    const HISTORY_MAX = 40;

    function pushHistory(){
      history.past.push(deepClone(state));
      if(history.past.length > HISTORY_MAX) history.past.shift();
      history.future = [];
      updateUndoRedoUI();
    }
    function canUndo(){ return history.past.length>0; }
    function canRedo(){ return history.future.length>0; }

    function updateUndoRedoUI(){
      $("btnUndo").disabled = !canUndo();
      $("btnRedo").disabled = !canRedo();
    }

    /* Save indicator */
    let saveTimer = null;
    let lastSavedAt = null;
    function setSaveState(mode){
      const dot = $("saveDot");
      const txt = $("saveText");
      if(mode==="saving"){
        dot.classList.add("saving"); dot.classList.remove("idle");
        txt.textContent = t("saving");
      }else if(mode==="saved"){
        dot.classList.remove("saving"); dot.classList.remove("idle");
        txt.textContent = t("saved");
      }else{
        dot.classList.remove("saving"); dot.classList.add("idle");
        txt.textContent = t("saved");
      }
    }
    function updateSaveLabel(force){
      if(!lastSavedAt && !force) return;
      const when = $("saveWhen");
      if(!when) return;
      if(!lastSavedAt){ when.textContent = ""; return; }
      const d = lastSavedAt;
      const pad = (n)=> String(n).padStart(2,"0");
      when.textContent = `${t("lastSaved")} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function scheduleSave(){
      setSaveState("saving");
      updateSaveLabel(false);
      clearTimeout(saveTimer);
      saveTimer = setTimeout(()=>{
        persist();
        lastSavedAt = new Date();
        setSaveState("saved");
        updateSaveLabel(true);
      }, 450);
    }

    function persist(){
      state.lang = currentLang;
      state.ts = new Date().toISOString();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function restore(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return false;
      try{
        const parsed = JSON.parse(raw);
        if(!parsed || typeof parsed !== "object") return false;
        state = parsed;
        if(state.lang==="de"||state.lang==="en") currentLang = state.lang;
        return true;
      }catch(e){
        return false;
      }
    }

    /* ================= jsMind init ================= */
    let jm = null;
    const jmOptions = {
      container:"jsmind_container",
      editable:true,
      theme:null,
      support_html:false,
      view:{
        engine:"svg" // crisp print
      },
      layout:{
        hspace:30, vspace:10, pspace:13
      },
      shortcut:{
        enable:false
      }
    };

    function initMind(){
      jm = new jsMind(jmOptions);
      jm.show({ meta:{ name:"mindmap", author:"", version:"1.0" }, format:"node_array", data: state.mind.nodes });

      // sync root topic with meta topic (if meta topic filled)
      if(state.meta.topic){
        try{ jm.update_node("root", state.meta.topic); }catch(e){}
      }

      // hook selection
      const cont = $("jsmind_container");
      cont.addEventListener("click", ()=>{
        updateSelectionPill();
        updateRatingUI();
        updateDraftFromSelection();
      });

      // basic zoom / pan
      wireZoomPan();
    }

    /* ===== Zoom / Pan (Scroll zoom, drag pan, recenter) ===== */
    function wireZoomPan(){
      const wrap = $("jmWrap");
      const cont = $("jsmind_container");

      let scale = 1;
      let pan = { x:0, y:0 };
      let dragging = false;
      let last = { x:0, y:0 };

      function applyTransform(){
        const el = cont.querySelector("svg") || cont.firstElementChild;
        if(!el) return;
        el.style.transformOrigin = "0 0";
        el.style.transform = `translate(${pan.x}px, ${pan.y}px) scale(${scale})`;
      }

      function recenter(){
        scale = 1;
        pan = { x:0, y:0 };
        applyTransform();
      }

      // wheel zoom
      wrap.addEventListener("wheel", (e)=>{
        e.preventDefault();
        const delta = (e.deltaY > 0) ? -0.08 : 0.08;
        scale = Math.min(2.2, Math.max(0.5, scale + delta));
        applyTransform();
      }, { passive:false });

      // drag pan
      wrap.addEventListener("mousedown", (e)=>{
        // do not pan when interacting with input elements
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
        if(tag==="input"||tag==="textarea"||tag==="button"||tag==="select") return;
        dragging = true;
        last = { x:e.clientX, y:e.clientY };
        wrap.style.cursor = "grabbing";
      });
      window.addEventListener("mousemove", (e)=>{
        if(!dragging) return;
        const dx = e.clientX - last.x;
        const dy = e.clientY - last.y;
        last = { x:e.clientX, y:e.clientY };
        pan.x += dx;
        pan.y += dy;
        applyTransform();
      });
      window.addEventListener("mouseup", ()=>{
        if(!dragging) return;
        dragging = false;
        wrap.style.cursor = "default";
      });

      $("btnRecenter").addEventListener("click", ()=> recenter());

      // expose
      wireZoomPan._recenter = recenter;
    }

    /* ===== Selected node helpers ===== */
    function getSelected(){
      if(!jm) return null;
      const s = jm.get_selected_node && jm.get_selected_node();
      return s || null;
    }

    function updateSelectionPill(){
      const sel = getSelected();
      const id = sel ? sel.id : "root";
      $("selNode").textContent = id;
      $("selPath").textContent = getNodePathText(sel) || "—";
    }

    function getNodePathText(node){
      try{
        const n = node || getSelected();
        if(!n) return "";
        const parts = [];
        let cur = n;
        while(cur){
          parts.push(cur.topic || cur.id);
          cur = cur.parent;
          if(cur && cur.id==="root"){ parts.push(cur.topic || "root"); break; }
        }
        return parts.reverse().join(" / ");
      }catch(e){
        return "";
      }
    }

    /* ===== Ratings ===== */
    function getRating(nodeId){
      return state.mind.ratings && state.mind.ratings[nodeId] ? state.mind.ratings[nodeId] : null;
    }
    function setRating(nodeId, rate){
      if(!state.mind.ratings) state.mind.ratings = {};
      if(rate===null) delete state.mind.ratings[nodeId];
      else state.mind.ratings[nodeId] = rate;
    }

    function updateRatingUI(){
      const sel = getSelected();
      const id = sel ? sel.id : "root";
      const r = getRating(id);

      document.querySelectorAll("#ratingRow .pill").forEach(p=>{
        p.classList.toggle("selected", p.dataset.rate === r);
      });

      const info = $("rateInfo");
      if(!r) info.textContent = `${t("rateInfo")} ${t("rateNone")}`;
      else info.textContent = `${t("rateInfo")} ${r==="red"?t("rateRed"):r==="yellow"?t("rateYellow"):t("rateGreen")}`;
    }

    document.querySelectorAll("#ratingRow .pill").forEach(p=>{
      p.addEventListener("click", ()=>{
        const sel = getSelected();
        const id = sel ? sel.id : "root";
        const rate = p.dataset.rate;
        pushHistory();
        setRating(id, rate);
        updateRatingUI();
        updateDraftFromSelection();
        scheduleSave();
      });
    });

    /* ===== Draft action ===== */
    function updateDraftFromSelection(){
      const sel = getSelected();
      const id = sel ? sel.id : "root";
      const path = getNodePathText(sel) || "—";
      const topic = (sel && sel.topic) ? sel.topic : "root";
      $("actFrom").value = `${path}  [${id}]`;
      updateDraftHint();
    }

    function updateDraftHint(){
      const sel = getSelected();
      const id = sel ? sel.id : "root";
      const r = getRating(id);
      const hint = $("draftHint");
      if(r==="green"){
        hint.textContent = t("needRedYellow");
      }else{
        hint.textContent = "";
      }
    }

    function clearDraft(){
      $("actText").value = "";
      $("actOwner").value = "";
      $("actDue").value = "";
      $("actStatus").value = "open";
      $("actNote").value = "";
    }

    $("btnClearDraft").addEventListener("click", ()=>{
      clearDraft();
      scheduleSave();
    });

    $("btnSaveAction").addEventListener("click", ()=>{
      const sel = getSelected();
      const id = sel ? sel.id : "root";
      const fromPath = getNodePathText(sel) || "—";
      const fromText = (sel && sel.topic) ? sel.topic : "root";

      const text = ($("actText").value || "").trim();
      if(!text){
        toast(currentLang==="de" ? "Bitte Maßnahme eingeben." : "Please enter an action.");
        return;
      }

      pushHistory();
      state.actions.push({
        id: uid(),
        fromId: id,
        fromPath,
        fromText,
        text,
        owner: ($("actOwner").value || "").trim(),
        due: $("actDue").value || "",
        status: $("actStatus").value || "open",
        note: ($("actNote").value || "").trim(),
        ts: new Date().toISOString()
      });

      renderActionsTable();
      clearDraft();
      toast(t("savedAction"));
      scheduleSave();
    });

    /* ===== Actions table ===== */
    function statusLabel(st){
      if(st==="done") return t("stDone");
      if(st==="drop") return t("stDrop");
      return t("stOpen");
    }
    function statusClass(st){
      if(st==="done") return "done";
      if(st==="drop") return "drop";
      return "open";
    }

    function renderActionsTable(){
      const tbody = $("actionsBody");
      tbody.innerHTML = "";

      if(!Array.isArray(state.actions) || state.actions.length===0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" style="color:var(--muted);font-size:13px;">${currentLang==="de"?"Noch keine Maßnahmen.":"No actions yet."}</td>`;
        tbody.appendChild(tr);
        return;
      }

      state.actions.forEach((a)=>{
        const tr = document.createElement("tr");
        tr.dataset.id = a.id;

        tr.innerHTML = `
          <td>
            <div style="font-weight:800;">${escapeHtml(a.text)}</div>
            ${a.note ? `<div style="color:var(--muted);font-size:12px;margin-top:4px;">${escapeHtml(a.note)}</div>` : ``}
          </td>
          <td style="color:var(--muted);font-size:12px;">
            <div><strong>${escapeHtml(a.fromText || "")}</strong></div>
            <div>${escapeHtml(a.fromPath || "")} <span style="opacity:.6;">[${escapeHtml(a.fromId||"")}]</span></div>
          </td>
          <td>${escapeHtml(a.owner||"")}</td>
          <td>${escapeHtml(a.due||"")}</td>
          <td><span class="status ${statusClass(a.status)}">${statusLabel(a.status)}</span></td>
          <td>
            <div class="row-actions">
              <button type="button" class="icon-btn" data-act="edit">${t("btnEdit")}</button>
              <button type="button" class="icon-btn danger" data-act="del">${t("btnDel")}</button>
            </div>
          </td>
        `;

        tbody.appendChild(tr);

        tr.querySelector('[data-act="del"]').addEventListener("click", ()=>{
          pushHistory();
          state.actions = state.actions.filter(x=>x.id !== a.id);
          renderActionsTable();
          scheduleSave();
        });

        tr.querySelector('[data-act="edit"]').addEventListener("click", ()=>{
          enterEditRow(tr, a);
        });
      });
    }

    function enterEditRow(tr, a){
      tr.innerHTML = `
        <td>
          <textarea class="textarea" style="min-height:60px;" data-edit="text">${escapeHtml(a.text)}</textarea>
          <input class="input" style="margin-top:8px;" data-edit="note" value="${escapeHtml(a.note||"")}" placeholder="${t("phActionNote")}">
        </td>
        <td style="color:var(--muted);font-size:12px;">
          <div><strong>${escapeHtml(a.fromText||"")}</strong></div>
          <div>${escapeHtml(a.fromPath||"")} <span style="opacity:.6;">[${escapeHtml(a.fromId||"")}]</span></div>
        </td>
        <td><input class="input" data-edit="owner" value="${escapeHtml(a.owner||"")}" placeholder="${t("phOwner")}"></td>
        <td><input class="input" type="date" data-edit="due" value="${escapeHtml(a.due||"")}"></td>
        <td>
          <select class="input" data-edit="status">
            <option value="open"${a.status==="open"?" selected":""}>${t("stOpen")}</option>
            <option value="done"${a.status==="done"?" selected":""}>${t("stDone")}</option>
            <option value="drop"${a.status==="drop"?" selected":""}>${t("stDrop")}</option>
          </select>
        </td>
        <td>
          <div class="row-actions">
            <button type="button" class="icon-btn" data-act="save">${t("btnUpdate")}</button>
            <button type="button" class="icon-btn" data-act="cancel">${t("btnCancel")}</button>
          </div>
        </td>
      `;

      tr.querySelector('[data-act="cancel"]').addEventListener("click", ()=>{
        renderActionsTable();
      });

      tr.querySelector('[data-act="save"]').addEventListener("click", ()=>{
        pushHistory();
        const upd = {
          text: tr.querySelector('[data-edit="text"]').value.trim(),
          note: tr.querySelector('[data-edit="note"]').value.trim(),
          owner: tr.querySelector('[data-edit="owner"]').value.trim(),
          due: tr.querySelector('[data-edit="due"]').value,
          status: tr.querySelector('[data-edit="status"]').value
        };
        state.actions = state.actions.map(x=> x.id===a.id ? {...x, ...upd} : x);
        renderActionsTable();
        scheduleSave();
      });
    }

    function escapeHtml(s){
      return String(s??"")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    /* ===== Mindmap commands (Child / Sibling / Delete) ===== */
    function syncMindToState(){
      if(!jm) return;
      const data = jm.get_data && jm.get_data("node_array");
      if(data && data.data) state.mind.nodes = data.data;
    }

    function addChild(){
      if(!jm) return;
      const sel = getSelected();
      const rootId = (jm.get_root && jm.get_root()) ? jm.get_root().id : "root";
      const parentId = sel ? sel.id : rootId;

      const text = prompt(t("promptNodeText"), "");
      if(text === null) return;
      const topic = (text || "").trim() || (currentLang==="de" ? "Neuer Knoten" : "New node");

      pushHistory();
      const id = uid();
      const ok = jm.add_node(parentId, id, topic);
      if(ok){
        try{ jm.expand_node(parentId); }catch(e){}
        jm.select_node(id);
        try{ jm.view && jm.view.scroll_node_to_center && jm.view.scroll_node_to_center(id); }catch(e){}
        updateSelectionPill();
        scheduleSave();
      }else{
        toast(t("warnAddFailed"));
      }
    }

    function addSibling(){
      if(!jm) return;
      const sel = getSelected();
      if(!sel){ toast(t("warnSelectNode")); return; }
      if(sel.id === "root"){ toast(t("warnSiblingRoot")); return; }

      const rootId = (jm.get_root && jm.get_root()) ? jm.get_root().id : "root";
      const parentId = sel.parent ? sel.parent.id : rootId;

      const text = prompt(t("promptNodeText"), "");
      if(text === null) return;
      const topic = (text || "").trim() || (currentLang==="de" ? "Neuer Knoten" : "New node");

      pushHistory();
      const id = uid();
      const ok = jm.add_node(parentId, id, topic);
      if(ok){
        try{ jm.expand_node(parentId); }catch(e){}
        jm.select_node(id);
        try{ jm.view && jm.view.scroll_node_to_center && jm.view.scroll_node_to_center(id); }catch(e){}
        updateSelectionPill();
        scheduleSave();
      }else{
        toast(t("warnAddFailed"));
      }
    }

    function deleteNode(){
      if(!jm) return;
      const sel = getSelected();
      if(!sel){ toast(t("warnSelectNode")); return; }
      if(sel.id === "root"){
        toast(currentLang==="de" ? "Root kann nicht gelöscht werden." : "Root cannot be deleted.");
        return;
      }
      if(!confirm(t("confirmDelete"))) return;

      pushHistory();
      // remove rating
      if(state.mind.ratings) delete state.mind.ratings[sel.id];
      jm.remove_node(sel.id);

      updateSelectionPill();
      updateRatingUI();
      updateDraftFromSelection();
      scheduleSave();
    }

    function resetMind(){
      if(!confirm(t("confirmReset"))) return;
      pushHistory();
      state.mind.nodes = [{ id:"root", isroot:true, topic: state.meta.topic || "Mindmap" }];
      state.mind.ratings = {};
      state.actions = [];
      history.future = [];
      history.past = [];
      updateUndoRedoUI();

      jm.show({ meta:{ name:"mindmap", author:"", version:"1.0" }, format:"node_array", data: state.mind.nodes });
      try{ wireZoomPan._recenter && wireZoomPan._recenter(); }catch(e){}
      renderActionsTable();
      updateSelectionPill();
      updateRatingUI();
      updateDraftFromSelection();
      scheduleSave();
    }

    function doUndo(){
      if(!canUndo()) return;
      syncMindToState();
      history.future.push(deepClone(state));
      state = history.past.pop();
      applyStateToUI(true);
      scheduleSave();
    }
    function doRedo(){
      if(!canRedo()) return;
      syncMindToState();
      history.past.push(deepClone(state));
      state = history.future.pop();
      applyStateToUI(true);
      scheduleSave();
    }

    function applyStateToUI(rebuildMind){
      // meta
      $("scopeTopic").value = state.meta.topic || "";
      $("scopeGoal").value = state.meta.goal || "";
      $("scopeScope").value = state.meta.scope || "";
      $("scopeNotes").value = state.meta.notes || "";

      if(rebuildMind && jm){
        jm.show({ meta:{ name:"mindmap", author:"", version:"1.0" }, format:"node_array", data: state.mind.nodes });
      }else if(jm){
        // still update root topic if changed
        try{ jm.update_node("root", state.meta.topic || (currentLang==="de"?"Mindmap":"Mind map")); }catch(e){}
      }

      renderActionsTable();
      updateSelectionPill();
      updateRatingUI();
      updateDraftFromSelection();
      updateUndoRedoUI();
    }

    /* UI button wire */
    // Add child/sibling via keyboard-like buttons (German labels)
    // we place them as context menu for selected node: using native jsMind commands:
    // We'll add two extra buttons under the map for clarity.
  </script>

  <!-- PART 1/3 ends here -->
